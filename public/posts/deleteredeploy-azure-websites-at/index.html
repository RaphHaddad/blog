<!doctype html>

<html lang="en-us">

<head>
  <title>Raph&#39;s Blog</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="The HTML5 Herald" />
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.49" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  <link rel="stylesheet" type="text/css" href="/css/styles.css" />
</head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="/">Raph&rsquo;s Blog</a>
            </h1>

      <ul id="social-media">
             
      </ul>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="/posts/">
                <i class="fa-li fa  fa-lg"></i><span>Archive</span>
            </a>
        </li>
        
    </ul>
</nav>

    <main>




<article>

    <h1>Delete/Redeploy Azure Websites at specific times within a TeamCity and Octopus Deploy CI/CD pipeline</h1>

    
        <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2015-05-29T09:53:00&#43;10:00">May 29, 2015</time>
        </li>
        
        

        
        <li>
            <em>
                
                    
                    <a href="/tags/ci/">#ci</a>
                
                    , 
                    <a href="/tags/devops/">#devops</a>
                
                    , 
                    <a href="/tags/agile/">#agile</a>
                
                    , 
                    <a href="/tags/cd/">#cd</a>
                
            </em>
        </li>
        

        <li>3 min read</li>
    </ul>
</aside>
    

    

<h3 id="problem">Problem</h3>

<p>Many clients request that specific environments be only available certain times during a day.</p>

<p>This is often due to the high cost associated with keeping environments that are not in use.</p>

<p>The problem here can be divided into two.</p>

<p>1. How do we make the environment unavailable?<br />
2. How do we make the environment available once more?</p>

<p>Microsoft will charge Azure services per compute time. Meaning that even if you stop your Azure Website it will still incur costs. <strong>This is the crux of the problem</strong>. It means that we have to deploy and <strong>delete the deployment</strong> of the Websites in order to minimise cost effectively.</p>

<p>Now if we have our project building, testing and deploying in a TeamCity and Octopus deploy pipeline. Ideally the Undeploy and Re-Deploy should be tunneled through the appropriate stage in the pipeline.</p>

<p>The reason why we should do this is to ensure that redeployment goes through the same processes as a normal deployment, and that environment states (such as version number, failed/passed) all have one source of truth - The CI/CD pipeline.</p>

<h3 id="a-solution">A Solution</h3>

<p>This solution assumes:</p>

<ol>
<li>That TeamCity is setupÂ </li>
<li>Octopus Deploy is setup and deploying. Either with custom PowerShell scripts or the build-in Octopus ones.</li>
</ol>

<p>There are three steps to the solution which I will show below.</p>

<ol>
<li>Write a PowerShell script that calls the Octopus REST API that simply re-deploys the latest release.</li>
<li>Write a PowerShell script that <em>deletes</em> the deployment on the environments.</li>
<li>Set triggers on TeamCity and call these scripts.</li>
</ol>

<h4 id="step-1-deploy-script">Step 1 - Deploy script</h4>

<p>I assume that you&rsquo;ve already got Octopus deploying successfully.</p>

<p>The next step is to create a PowerShell script that <strong>calls the Octopus API</strong> and deploys your application from Octopus. The logic is:</p>

<ol>
<li>Find the environment</li>
<li>Get the <strong><em>current deployed release</em></strong> on that specific environment</li>
<li>Redeploy this release</li>
</ol>

<p>An example of this script can be found <a href="https://github.com/RaphHaddad/DeleteRedeployAzureWebsites/blob/master/Deploy-From-Octopus.ps1">here</a>.</p>

<p>Basically this script &lsquo;redeploys&rsquo; the latest release on a given environment. The reason why we have parametised the environment is that many organisations have more that one testing environment they need taken down during non-operational hours.</p>

<h4 id="step-2-undeploy-delete-script">Step 2 - Undeploy/delete script</h4>

<p>As I stated previously, we need to actually delete an environment in this case, because of the way Azure has priced its services.</p>

<p>We opted to use the Azure cmdlets to do this. An example can be found <a href="https://github.com/RaphHaddad/DeleteRedeployAzureWebsites/blob/master/Delete-Deployment.ps1">here</a>.</p>

<h4 id="step-3-teamcity-triggers">Step 3 - TeamCity triggers</h4>

<p>Now, the final step is to setup your TeamCity triggers to execute the above scripts at the appropriate times.</p>

<p><em>Typically</em>, the deploy script (from step 1) will be executed in the morning and the updeploy/delete script (from step 2) will be executed in the evening.</p>

<p>What I prefer doing is having two build configurations for each of the above. A deploy configuration and an undeploy.</p>

<p><a href="http://4.bp.blogspot.com/-uzCwRWSh9Gk/VVV_NuC3-yI/AAAAAAAAHyE/5guQnH9waZo/s1600/2015-05-15%2B15_07_12-Projects%2B%E2%80%94%2BTeamCity.png"><img src="http://4.bp.blogspot.com/-uzCwRWSh9Gk/VVV_NuC3-yI/AAAAAAAAHyE/5guQnH9waZo/s1600/2015-05-15%2B15_07_12-Projects%2B%E2%80%94%2BTeamCity.png" alt="" /></a></p>

<p>Setup each of the build configuration. Then go to build steps and add the powershell script.</p>

<p><a href="http://1.bp.blogspot.com/-dgCccYEb_uM/VWepCyBH58I/AAAAAAAAIRI/Q-MjPb1EtpE/s1600/tc.png"><img src="http://1.bp.blogspot.com/-dgCccYEb_uM/VWepCyBH58I/AAAAAAAAIRI/Q-MjPb1EtpE/s640/tc.png" alt="" /></a></p>

<p>Then go to triggers and add a &lsquo;schedule trigger&rsquo;.</p>

<p><a href="http://3.bp.blogspot.com/-MPmK7SMoFKc/VWeqBIRRuQI/AAAAAAAAIRU/1rmw7JFP7hA/s1600/tc1.png"><img src="http://3.bp.blogspot.com/-MPmK7SMoFKc/VWeqBIRRuQI/AAAAAAAAIRU/1rmw7JFP7hA/s640/tc1.png" alt="" /></a></p>

<p>And that&rsquo;s it! You&rsquo;re done.</p>

<h4 id="summary">Summary</h4>

<p>1. Create deploy script using Octopus API.</p>

<p>2. Create delete deployment script using Azure cmdlets.</p>

<p>3. Use TC as script runner and schedule scripts.</p>


</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="http://example.org/posts/powershell-from-sourcetree-as-custom-comments/"><i class="fa fa-chevron-circle-left"></i> PowerShell from SourceTree as a custom action</a>
        </li>
        
        
        <li>
            <a href="http://example.org/posts/deleteredeploy-azure-websites-at-comments/">Delete/Redeploy Azure Websites at specific times within a TeamCity and Octopus Deploy CI/CD pipeline <i class="fa fa-chevron-circle-right"></i> </a>
        </li>
        
    </ul>
</section>
    





</main>
    <footer>
        <h6> | 
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="http://example.org/index.xml">Subscribe</a></h6>
    </footer>
</div>
<script src="/js/scripts.js"></script>
</body>

</html>